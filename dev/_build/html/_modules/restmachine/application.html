

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>restmachine.application &mdash; restmachine 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            restmachine
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">restmachine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">restmachine.application</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for restmachine.application</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Main application class for the REST framework.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_qs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
    <span class="n">get_args</span><span class="p">,</span>
    <span class="n">get_origin</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.content_renderers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ContentRenderer</span><span class="p">,</span>
    <span class="n">HTMLRenderer</span><span class="p">,</span>
    <span class="n">JSONRenderer</span><span class="p">,</span>
    <span class="n">PlainTextRenderer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.dependencies</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AcceptsWrapper</span><span class="p">,</span>
    <span class="n">ContentNegotiationWrapper</span><span class="p">,</span>
    <span class="n">Dependency</span><span class="p">,</span>
    <span class="n">DependencyCache</span><span class="p">,</span>
    <span class="n">DependencyScope</span><span class="p">,</span>
    <span class="n">DependencyWrapper</span><span class="p">,</span>
    <span class="n">HeadersWrapper</span><span class="p">,</span>
    <span class="n">ValidationWrapper</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">PYDANTIC_AVAILABLE</span><span class="p">,</span> <span class="n">AcceptsParsingError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPMethod</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.router</span><span class="w"> </span><span class="kn">import</span> <span class="n">Router</span>

<span class="c1"># Set up logger for this module</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ErrorHandler">
<a class="viewcode-back" href="../../api.html#restmachine.application.ErrorHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ErrorHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a custom error handler.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ErrorHandler.__init__">
<a class="viewcode-back" href="../../api.html#restmachine.application.ErrorHandler.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">status_codes</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">content_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_codes</span> <span class="o">=</span> <span class="n">status_codes</span>  <span class="c1"># Empty tuple means default handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="n">content_type</span>  <span class="c1"># None means default for that status code</span></div>


<div class="viewcode-block" id="ErrorHandler.handles_status">
<a class="viewcode-back" href="../../api.html#restmachine.application.ErrorHandler.handles_status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handles_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this handler handles the given status code.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_codes</span><span class="p">:</span>  <span class="c1"># Default handler handles all codes</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_codes</span></div>


<div class="viewcode-block" id="ErrorHandler.matches_accept">
<a class="viewcode-back" href="../../api.html#restmachine.application.ErrorHandler.matches_accept">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">matches_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accept_header</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this handler matches the Accept header.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">:</span>  <span class="c1"># Default handler matches all</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">accept_header</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># Simple check for content type in Accept header</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="ow">in</span> <span class="n">accept_header</span> <span class="ow">or</span> <span class="s2">&quot;*/*&quot;</span> <span class="ow">in</span> <span class="n">accept_header</span></div>
</div>



<div class="viewcode-block" id="RouteHandler">
<a class="viewcode-back" href="../../api.html#restmachine.application.RouteHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RouteHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a registered route and its handler.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RouteHandler.__init__">
<a class="viewcode-back" href="../../api.html#restmachine.application.RouteHandler.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">HTTPMethod</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compile_path_pattern</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_renderers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ContentNegotiationWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_wrappers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ValidationWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Cache signature and parameter info for performance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler_signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler_signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># State machine callbacks resolved from handler dependencies</span>
        <span class="c1"># These are the ONLY route-specific lookups we maintain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_callbacks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Deprecated - kept for compatibility but should not be used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">DependencyWrapper</span><span class="p">,</span> <span class="n">Dependency</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ValidationWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers_dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">HeadersWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accepts_dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AcceptsWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_compile_path_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert path with {param} syntax to a pattern for matching.&quot;&quot;&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{(\w+)\}&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;\1&gt;[^/]+)&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">$&quot;</span>

<div class="viewcode-block" id="RouteHandler.add_content_renderer">
<a class="viewcode-back" href="../../api.html#restmachine.application.RouteHandler.add_content_renderer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_content_renderer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">:</span> <span class="n">ContentNegotiationWrapper</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a content-specific renderer for this route.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content_renderers</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="RouteHandler.add_validation_wrapper">
<a class="viewcode-back" href="../../api.html#restmachine.application.RouteHandler.add_validation_wrapper">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_validation_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">:</span> <span class="n">ValidationWrapper</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_wrappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)</span></div>


<div class="viewcode-block" id="RouteHandler.resolve_state_callbacks">
<a class="viewcode-back" href="../../api.html#restmachine.application.RouteHandler.resolve_state_callbacks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_state_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">:</span> <span class="s1">&#39;RestApplication&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Analyze handler dependencies and resolve state machine callbacks.</span>

<span class="sd">        This traverses the dependency graph to find state machine callbacks</span>
<span class="sd">        that apply to this route&#39;s handler, enabling O(1) lookup during request processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># State machine callback types to look for</span>
        <span class="n">state_callback_types</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;resource_exists&#39;</span><span class="p">,</span> <span class="s1">&#39;resource_from_request&#39;</span><span class="p">,</span> <span class="s1">&#39;forbidden&#39;</span><span class="p">,</span> <span class="s1">&#39;authorized&#39;</span><span class="p">,</span>
            <span class="s1">&#39;generate_etag&#39;</span><span class="p">,</span> <span class="s1">&#39;last_modified&#39;</span>
        <span class="p">}</span>

        <span class="c1"># Analyze each parameter of the handler</span>
        <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Check if this parameter is directly wrapped with a state callback</span>
            <span class="c1"># Two cases:</span>
            <span class="c1"># 1. param_name directly maps to a dependency (e.g., @dependency(name=&#39;foo&#39;))</span>
            <span class="c1"># 2. param_name matches a state_name from a DependencyWrapper (e.g., generate_etag)</span>

            <span class="c1"># Case 1: Direct dependency lookup</span>
            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">:</span>
                <span class="n">dep</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">DependencyWrapper</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dep</span><span class="o">.</span><span class="n">state_name</span> <span class="ow">in</span> <span class="n">state_callback_types</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state_callbacks</span><span class="p">[</span><span class="n">dep</span><span class="o">.</span><span class="n">state_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">func</span>

            <span class="c1"># Case 2: Search for matching state_name across all dependencies</span>
            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">state_callback_types</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dep_key</span><span class="p">,</span> <span class="n">dep_value</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">_dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep_value</span><span class="p">,</span> <span class="n">DependencyWrapper</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dep_value</span><span class="o">.</span><span class="n">state_name</span> <span class="o">==</span> <span class="n">param_name</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">state_callbacks</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dep_value</span><span class="o">.</span><span class="n">func</span>
                        <span class="k">break</span></div>
</div>



<div class="viewcode-block" id="RestApplication">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RestApplication</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main application class for the REST framework.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RestApplication.__init__">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">DependencyWrapper</span><span class="p">,</span> <span class="n">Dependency</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ValidationWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers_dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">HeadersWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AcceptsWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span> <span class="o">=</span> <span class="n">DependencyCache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_renderers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ContentRenderer</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error_handlers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ErrorHandler</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request_id_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trace_id_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_startup_handlers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_handlers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_startup_executed</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Guard to prevent double execution</span>

        <span class="c1"># Create default root router - all routes go through this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span> <span class="o">=</span> <span class="n">Router</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Add default content renderers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_content_renderer</span><span class="p">(</span><span class="n">JSONRenderer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_content_renderer</span><span class="p">(</span><span class="n">HTMLRenderer</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_content_renderer</span><span class="p">(</span><span class="n">PlainTextRenderer</span><span class="p">())</span>

        <span class="c1"># Register built-in dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_builtin_dependencies</span><span class="p">()</span></div>


<div class="viewcode-block" id="RestApplication.add_content_renderer">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.add_content_renderer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_content_renderer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renderer</span><span class="p">:</span> <span class="n">ContentRenderer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a global content renderer.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_content_renderers</span><span class="p">[</span><span class="n">renderer</span><span class="o">.</span><span class="n">media_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">renderer</span></div>


<div class="viewcode-block" id="RestApplication.mount">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.mount">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">router</span><span class="p">:</span> <span class="n">Router</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mount a router with a given prefix.</span>

<span class="sd">        Args:</span>
<span class="sd">            prefix: The path prefix for all routes in the mounted router</span>
<span class="sd">            router: The router to mount</span>

<span class="sd">        Example:</span>
<span class="sd">            app = RestApplication()</span>
<span class="sd">            users_router = Router()</span>
<span class="sd">            users_router.get(&quot;/&quot;)(lambda: {&quot;users&quot;: []})</span>
<span class="sd">            users_router.get(&quot;/{id}&quot;)(lambda id: {&quot;user&quot;: id})</span>

<span class="sd">            app.mount(&quot;/users&quot;, users_router)</span>
<span class="sd">            # This creates routes: GET /users/ and GET /users/{id}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">router</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_register_builtin_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register all built-in framework dependencies.</span>

<span class="sd">        This makes built-in dependencies use the same registration mechanism as</span>
<span class="sd">        user-defined dependencies, making the system more consistent and extensible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Simple built-in dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;request&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;query_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;path_params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span> <span class="ow">or</span> <span class="p">{},</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;request_headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>  <span class="c1"># Deprecated</span>

        <span class="c1"># Built-in dependencies that need application context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;exception&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exception&quot;</span><span class="p">),</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;response_headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_response_headers</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_request_id</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;trace_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_trace_id</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>

        <span class="c1"># Body parser dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;json_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_json_body</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;form_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_form_body</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;multipart_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_multipart_body</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="s2">&quot;text_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_text_body</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;request&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_response_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Built-in dependency provider for response_headers.&quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;response_headers&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get current route from cache (set during request processing)</span>
            <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__current_route__&quot;</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_initial_headers</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;response_headers&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_request_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Built-in dependency provider for request_id.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_id_provider</span><span class="p">:</span>
            <span class="c1"># Get current route from cache</span>
            <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__current_route__&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_injection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request_id_provider</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_trace_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Built-in dependency provider for trace_id.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_id_provider</span><span class="p">:</span>
            <span class="c1"># Get current route from cache</span>
            <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__current_route__&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_injection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_trace_id_provider</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_json_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Built-in dependency provider for json_body.&quot;&quot;&quot;</span>
        <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__current_route__&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_body</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="s2">&quot;application/json&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_form_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Built-in dependency provider for form_body.&quot;&quot;&quot;</span>
        <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__current_route__&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_body</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_multipart_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Built-in dependency provider for multipart_body.&quot;&quot;&quot;</span>
        <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__current_route__&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_body</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="s2">&quot;multipart/form-data&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_text_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Built-in dependency provider for text_body.&quot;&quot;&quot;</span>
        <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__current_route__&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_body</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RestApplication.dependency">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.dependency">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">DependencyScope</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a dependency provider.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Optional name for the dependency. If not provided, uses the function name.</span>
<span class="sd">            scope: Dependency scope - &quot;request&quot; (default) or &quot;session&quot;.</span>
<span class="sd">                   - &quot;request&quot;: Cached per request, cleared between requests</span>
<span class="sd">                   - &quot;session&quot;: Cached across all requests, never cleared automatically</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
            <span class="n">dep_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">dep_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="k">return</span> <span class="n">decorator</span></div>


    <span class="c1"># State machine callback decorators for dependencies</span>
<div class="viewcode-block" id="RestApplication.resource_exists">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.resource_exists">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resource_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">DependencyScope</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to wrap a dependency with resource existence checking.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope: Dependency scope - &quot;request&quot; (default) or &quot;session&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">DependencyWrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;resource_exists&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.resource_from_request">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.resource_from_request">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resource_from_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">DependencyScope</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to wrap a dependency for creating resource from request (for POST).</span>

<span class="sd">        Args:</span>
<span class="sd">            scope: Dependency scope - &quot;request&quot; (default) or &quot;session&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">DependencyWrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;resource_from_request&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.forbidden">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.forbidden">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forbidden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">DependencyScope</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to wrap a dependency with forbidden checking.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope: Dependency scope - &quot;request&quot; (default) or &quot;session&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">DependencyWrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;forbidden&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.authorized">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.authorized">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">authorized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">DependencyScope</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to wrap a dependency with authorization checking.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope: Dependency scope - &quot;request&quot; (default) or &quot;session&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">DependencyWrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;authorized&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.default_headers">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_headers">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a global headers manipulation function.&quot;&quot;&quot;</span>
        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">HeadersWrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.generate_etag">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.generate_etag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_etag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">DependencyScope</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to wrap a dependency with ETag generation for conditional requests.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope: Dependency scope - &quot;request&quot; (default) or &quot;session&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">DependencyWrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;generate_etag&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.last_modified">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.last_modified">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">DependencyScope</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to wrap a dependency with Last-Modified date for conditional requests.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope: Dependency scope - &quot;request&quot; (default) or &quot;session&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">DependencyWrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;last_modified&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span>
        <span class="k">return</span> <span class="n">func</span></div>


    <span class="c1"># Content negotiation decorators</span>
<div class="viewcode-block" id="RestApplication.renders">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.renders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">renders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">DependencyScope</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a content-type specific renderer for an endpoint.</span>

<span class="sd">        NOTE: This still requires the decorator to be placed after the route decorator</span>
<span class="sd">        to attach the renderer to the correct route.</span>

<span class="sd">        Args:</span>
<span class="sd">            content_type: The content type this renderer produces</span>
<span class="sd">            scope: Dependency scope - &quot;request&quot; (default) or &quot;session&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
            <span class="c1"># Find the most recently added route in the root router</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">_routes</span><span class="p">:</span>
                <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">_routes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">handler_name</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">wrapper</span> <span class="o">=</span> <span class="n">ContentNegotiationWrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">handler_name</span><span class="p">)</span>
                <span class="n">route</span><span class="o">.</span><span class="n">add_content_renderer</span><span class="p">(</span><span class="n">content_type</span><span class="p">,</span> <span class="n">wrapper</span><span class="p">)</span>

            <span class="c1"># Also register this as a dependency so it can be injected</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="k">return</span> <span class="n">decorator</span></div>


    <span class="c1"># Simplified validation decorator - just expects Pydantic model return</span>
<div class="viewcode-block" id="RestApplication.validates">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.validates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">DependencyScope</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to mark a function as returning a validated Pydantic model.</span>

<span class="sd">        Args:</span>
<span class="sd">            scope: Dependency scope - &quot;request&quot; (default) or &quot;session&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PYDANTIC_AVAILABLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Pydantic is required for validation features&quot;</span><span class="p">)</span>

        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">ValidationWrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validation_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.accepts">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.accepts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">accepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">DependencyScope</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a global content-type specific body parser.</span>

<span class="sd">        Args:</span>
<span class="sd">            content_type: The content type this parser handles</span>
<span class="sd">            scope: Dependency scope - &quot;request&quot; (default) or &quot;session&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
            <span class="n">wrapper</span> <span class="o">=</span> <span class="n">AcceptsWrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependencies</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrapper</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="k">return</span> <span class="n">decorator</span></div>


    <span class="c1"># Default state machine callbacks</span>
<div class="viewcode-block" id="RestApplication.default_service_available">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_service_available">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_service_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a default service_available callback.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">[</span><span class="s2">&quot;service_available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.default_known_method">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_known_method">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_known_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a default known_method callback.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">[</span><span class="s2">&quot;known_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.default_uri_too_long">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_uri_too_long">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_uri_too_long</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a default uri_too_long callback.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">[</span><span class="s2">&quot;uri_too_long&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.default_method_allowed">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_method_allowed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_method_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a default method_allowed callback.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">[</span><span class="s2">&quot;method_allowed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.default_malformed_request">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_malformed_request">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_malformed_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a default malformed_request callback.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">[</span><span class="s2">&quot;malformed_request&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.default_authorized">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_authorized">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_authorized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a default authorized callback.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">[</span><span class="s2">&quot;authorized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.default_forbidden">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_forbidden">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_forbidden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a default forbidden callback.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">[</span><span class="s2">&quot;forbidden&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.default_content_headers_valid">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_content_headers_valid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_content_headers_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a default content_headers_valid callback.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">[</span><span class="s2">&quot;content_headers_valid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.default_resource_exists">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_resource_exists">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_resource_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a default resource_exists callback.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">[</span><span class="s2">&quot;resource_exists&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.default_route_not_found">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.default_route_not_found">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">default_route_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a default route_not_found callback.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_callbacks</span><span class="p">[</span><span class="s2">&quot;route_not_found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


    <span class="c1"># Error handler decorators</span>
<div class="viewcode-block" id="RestApplication.handles_error">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.handles_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handles_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">status_codes</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a custom error handler.</span>

<span class="sd">        Args:</span>
<span class="sd">            *status_codes: HTTP status codes this handler handles.</span>
<span class="sd">                          If empty, this becomes the default handler for all errors.</span>

<span class="sd">        Example::</span>

<span class="sd">            @app.handles_error(404)</span>
<span class="sd">            def custom_404(request):</span>
<span class="sd">                return {&quot;error&quot;: &quot;Resource not found&quot;, &quot;code&quot;: &quot;NOT_FOUND&quot;}</span>

<span class="sd">            @app.handles_error()  # Default handler for all errors</span>
<span class="sd">            def default_error(request, exception):</span>
<span class="sd">                return {&quot;error&quot;: &quot;Something went wrong&quot;}</span>

<span class="sd">            @app.handles_error(401, 403)  # Handle multiple codes</span>
<span class="sd">            def auth_error(request):</span>
<span class="sd">                return {&quot;error&quot;: &quot;Authentication required&quot;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">status_codes</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">decorator</span></div>


<div class="viewcode-block" id="RestApplication.error_renders">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.error_renders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">error_renders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to specify content type for an error handler.</span>

<span class="sd">        Must be used with handles_error decorator. This creates a content-type-specific</span>
<span class="sd">        error handler separate from regular route handlers to avoid confusion.</span>

<span class="sd">        IMPORTANT: This decorator must be placed ABOVE @handles_error (applied first).</span>

<span class="sd">        Args:</span>
<span class="sd">            content_type: The content type this error handler produces</span>

<span class="sd">        Example::</span>

<span class="sd">            @app.error_renders(&quot;text/html&quot;)</span>
<span class="sd">            @app.handles_error(404)</span>
<span class="sd">            def custom_404_html(request):</span>
<span class="sd">                return &quot;&lt;h1&gt;404 - Not Found&lt;/h1&gt;&quot;</span>

<span class="sd">            @app.error_renders(&quot;application/json&quot;)</span>
<span class="sd">            @app.handles_error(404)</span>
<span class="sd">            def custom_404_json(request):</span>
<span class="sd">                return {&quot;error&quot;: &quot;Not found&quot;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
            <span class="c1"># Find the most recently added error handler and update its content type</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_handlers</span><span class="p">:</span>
                <span class="c1"># The decorator is applied bottom-up, so the last handler added</span>
                <span class="c1"># is the one we just registered with @handles_error</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_handlers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">handler</span> <span class="o">==</span> <span class="n">func</span><span class="p">:</span>
                    <span class="c1"># Create a new handler with the same status codes but specific content type</span>
                    <span class="n">new_handler</span> <span class="o">=</span> <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">handler</span><span class="o">.</span><span class="n">status_codes</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span>
                    <span class="c1"># Replace the last handler</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_error_handlers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_handler</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">decorator</span></div>


    <span class="c1"># Request/Trace ID decorators</span>
<div class="viewcode-block" id="RestApplication.request_id">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.request_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">request_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a custom request ID generator.</span>

<span class="sd">        The decorated function should accept a Request object and return a string.</span>
<span class="sd">        If not provided, a default UUID-based generator will be used.</span>

<span class="sd">        Example::</span>

<span class="sd">            @app.request_id</span>
<span class="sd">            def generate_request_id(request):</span>
<span class="sd">                # Check for existing request ID in headers</span>
<span class="sd">                return request.headers.get(&#39;X-Request-ID&#39;, str(uuid.uuid4()))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request_id_provider</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RestApplication.trace_id">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.trace_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">trace_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a custom trace ID generator.</span>

<span class="sd">        The decorated function should accept a Request object and return a string.</span>
<span class="sd">        If not provided, a default UUID-based generator will be used.</span>

<span class="sd">        Example::</span>

<span class="sd">            @app.trace_id</span>
<span class="sd">            def generate_trace_id(request):</span>
<span class="sd">                # Check for existing trace ID in headers</span>
<span class="sd">                return request.headers.get(&#39;X-Trace-ID&#39;, str(uuid.uuid4()))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trace_id_provider</span> <span class="o">=</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">func</span></div>


    <span class="c1"># HTTP method decorators</span>
<div class="viewcode-block" id="RestApplication.get">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a GET route handler on the root router.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.post">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.post">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a POST route handler on the root router.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.put">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.put">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a PUT route handler on the root router.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.delete">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.delete">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a DELETE route handler on the root router.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.patch">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.patch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a PATCH route handler on the root router.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_dependency</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">param_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">],</span> <span class="n">request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Request</span><span class="p">],</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve a dependency by name and type.</span>

<span class="sd">        Raises ValueError if the dependency cannot be found, which indicates a programming error.</span>

<span class="sd">        Args:</span>
<span class="sd">            param_name: Name of the parameter to resolve</span>
<span class="sd">            param_type: Type annotation of the parameter (if available)</span>
<span class="sd">            request: Request object (can be None for shutdown handlers)</span>
<span class="sd">            route: Route handler (can be None for shutdown handlers)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store route in cache so built-in dependencies can access it</span>
        <span class="k">if</span> <span class="n">route</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;__current_route__&quot;</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="s2">&quot;request&quot;</span><span class="p">)</span>

        <span class="c1"># Get dependency scope</span>
        <span class="n">dep_scope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dependency_scope</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>

        <span class="c1"># Check cache first (using appropriate scope)</span>
        <span class="n">cached_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">dep_scope</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached_value</span>

        <span class="c1"># Handle Request type annotation or &quot;request&quot; parameter name</span>
        <span class="k">if</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">Request</span> <span class="ow">or</span> <span class="n">param_name</span> <span class="o">==</span> <span class="s2">&quot;request&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot inject &#39;request&#39; in shutdown handlers - no request context available&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">dep_scope</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">request</span>

        <span class="c1"># Check if the parameter name is in path_params</span>
        <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span> <span class="ow">and</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="p">:</span>
            <span class="n">path_value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">path_value</span><span class="p">,</span> <span class="n">dep_scope</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">path_value</span>

        <span class="c1"># Check if this is a registered dependency (built-in or custom)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_exists</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">route</span><span class="p">):</span>
            <span class="n">resolved_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_registered_dependency</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">resolved_value</span><span class="p">,</span> <span class="n">dep_scope</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resolved_value</span>

        <span class="c1"># Check if this is an accepts parser dependency (only if we have a request)</span>
        <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependency_exists</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">):</span>
            <span class="n">accepts_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_accepts_dependency</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">accepts_value</span><span class="p">,</span> <span class="n">dep_scope</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">accepts_value</span>

        <span class="c1"># Dependency not found - this is a programming error</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to resolve dependency: </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_dependency_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DependencyScope</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the scope for a dependency.</span>

<span class="sd">        Args:</span>
<span class="sd">            param_name: Name of the dependency</span>
<span class="sd">            route: Optional route (unused, kept for compatibility)</span>

<span class="sd">        Returns:</span>
<span class="sd">            The scope (&quot;request&quot; or &quot;session&quot;), defaults to &quot;request&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check global dependencies</span>
        <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">:</span>
            <span class="n">dep_or_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dep_or_wrapper</span><span class="p">,</span> <span class="s1">&#39;scope&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">dep_or_wrapper</span><span class="o">.</span><span class="n">scope</span>

        <span class="c1"># Check validation dependencies</span>
        <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_dependencies</span><span class="p">:</span>
            <span class="n">validation_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_dependencies</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">validation_wrapper</span><span class="p">,</span> <span class="s1">&#39;scope&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">validation_wrapper</span><span class="o">.</span><span class="n">scope</span>

        <span class="c1"># Default to request scope</span>
        <span class="k">return</span> <span class="s2">&quot;request&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_dependency_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if a registered dependency exists.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_registered_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Request</span><span class="p">],</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve a registered dependency (built-in or custom).</span>

<span class="sd">        Returns the resolved value, which may be None for some dependencies like &#39;exception&#39;.</span>
<span class="sd">        Assumes _dependency_exists() was called first and returned True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dep_or_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
        <span class="n">validation_dependency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep_or_wrapper</span><span class="p">,</span> <span class="n">DependencyWrapper</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_injection</span><span class="p">(</span><span class="n">dep_or_wrapper</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep_or_wrapper</span><span class="p">,</span> <span class="n">Dependency</span><span class="p">):</span>
            <span class="c1"># Unwrap the Dependency wrapper</span>
            <span class="k">if</span> <span class="n">validation_dependency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_injection</span><span class="p">(</span><span class="n">dep_or_wrapper</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;model_validate&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;model_dump&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation function </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> must return a Pydantic model&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_injection</span><span class="p">(</span><span class="n">dep_or_wrapper</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">validation_dependency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_injection</span><span class="p">(</span><span class="n">dep_or_wrapper</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;model_validate&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;model_dump&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation function </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2"> must return a Pydantic model&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_injection</span><span class="p">(</span><span class="n">dep_or_wrapper</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_accepts_dependency_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an accepts parser dependency exists for this request.&quot;&quot;&quot;</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">base_content_type</span> <span class="o">=</span> <span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Check global accepts dependencies</span>
        <span class="n">accepts_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_content_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">accepts_wrapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">param_name</span> <span class="o">==</span> <span class="n">accepts_wrapper</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;parsed_data&#39;</span><span class="p">,</span> <span class="s1">&#39;parsed_body&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_accepts_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve accepts parser dependencies.</span>

<span class="sd">        Assumes _accepts_dependency_exists() was called first and returned True.</span>
<span class="sd">        Returns the resolved value, which may be None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">content_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Content-Type header is required for dependency </span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">base_content_type</span> <span class="o">=</span> <span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Check global accepts dependencies</span>
        <span class="n">accepts_wrapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AcceptsWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_content_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">accepts_wrapper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accepts parser for </span><span class="si">{</span><span class="n">base_content_type</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_injection</span><span class="p">(</span><span class="n">accepts_wrapper</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AcceptsParsingError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to parse </span><span class="si">{</span><span class="n">base_content_type</span><span class="si">}</span><span class="s2"> request body: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">original_exception</span><span class="o">=</span><span class="n">e</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call_with_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Request</span><span class="p">],</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call a function with dependency injection.&quot;&quot;&quot;</span>
        <span class="c1"># Use cached signature if this is the route handler</span>
        <span class="k">if</span> <span class="n">route</span> <span class="ow">and</span> <span class="n">func</span> <span class="o">==</span> <span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">handler_signature</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">param_type</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
                <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">resolved_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_dependency</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">param_type</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolved_value</span>

        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_initial_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get initial headers with Vary header pre-calculated.&quot;&quot;&quot;</span>
        <span class="n">vary_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">):</span>
            <span class="n">vary_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">)</span>

        <span class="c1"># Check if multiple content types are available</span>
        <span class="n">available_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_content_renderers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">route</span> <span class="ow">and</span> <span class="n">route</span><span class="o">.</span><span class="n">content_renderers</span><span class="p">:</span>
            <span class="n">available_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">content_renderers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">vary_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Accept&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;Vary&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vary_values</span><span class="p">)}</span> <span class="k">if</span> <span class="n">vary_values</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">],</span> <span class="n">expected_content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse request body based on content type using accepts dependencies or built-in parsers.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;application/octet-stream&quot;</span>
        <span class="n">base_content_type</span> <span class="o">=</span> <span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Check for custom accepts parser first</span>
        <span class="n">accepts_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_accepts_wrapper</span><span class="p">(</span><span class="n">base_content_type</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">accepts_wrapper</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_with_injection</span><span class="p">(</span><span class="n">accepts_wrapper</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AcceptsParsingError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to parse </span><span class="si">{</span><span class="n">base_content_type</span><span class="si">}</span><span class="s2"> request body: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">original_exception</span><span class="o">=</span><span class="n">e</span>
                <span class="p">)</span>

        <span class="c1"># Validate content type is supported</span>
        <span class="k">if</span> <span class="n">base_content_type</span> <span class="o">!=</span> <span class="n">expected_content_type</span><span class="p">:</span>
            <span class="n">supported_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_supported_content_types</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_content_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_types</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported Media Type - 415&quot;</span><span class="p">)</span>

        <span class="c1"># Use built-in parsers</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_with_builtin_parser</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">expected_content_type</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_accepts_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get accepts wrapper for content type from global dependencies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">content_type</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_supported_content_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all supported content types for validation.&quot;&quot;&quot;</span>
        <span class="n">supported_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependencies</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">supported_types</span><span class="o">.</span><span class="n">update</span><span class="p">([</span>
            <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">,</span>
            <span class="s2">&quot;multipart/form-data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;text/plain&quot;</span>
        <span class="p">])</span>
        <span class="k">return</span> <span class="n">supported_types</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_with_builtin_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">content_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse body using built-in parsers.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;application/json&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">:</span>
                <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">keep_blank_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">values</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">parsed</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">elif</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;multipart/form-data&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;_raw_body&quot;</span><span class="p">:</span> <span class="n">body</span><span class="p">,</span> <span class="s2">&quot;_content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;multipart/form-data&quot;</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">body</span>
            <span class="k">return</span> <span class="n">body</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AcceptsParsingError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to parse </span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2"> request body: Invalid JSON - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">original_exception</span><span class="o">=</span><span class="n">e</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AcceptsParsingError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to parse </span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2"> request body: Invalid form data - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">original_exception</span><span class="o">=</span><span class="n">e</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AcceptsParsingError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to parse </span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2"> request body: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">original_exception</span><span class="o">=</span><span class="n">e</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_find_route</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">HTTPMethod</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find a matching route for the given method and path.</span>

<span class="sd">        Uses the root router&#39;s trie-based matching for efficient O(k) lookup.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">match_route</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_path_has_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if any route exists for the given path (regardless of method).</span>

<span class="sd">        Uses the root router&#39;s trie-based lookup for efficient checking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">has_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<div class="viewcode-block" id="RestApplication.on_startup">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.on_startup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_startup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a startup handler to run when the application starts.</span>

<span class="sd">        Can be used as a decorator::</span>

<span class="sd">            @app.on_startup</span>
<span class="sd">            async def database():</span>
<span class="sd">                print(&quot;Opening database connection...&quot;)</span>
<span class="sd">                return create_db_connection()</span>

<span class="sd">            @app.get(&quot;/users&quot;)</span>
<span class="sd">            def get_users(database):  # database from startup is injected here</span>
<span class="sd">                return database.query(&quot;SELECT * FROM users&quot;)</span>

<span class="sd">        Or called directly::</span>

<span class="sd">            app.on_startup(my_startup_function)</span>

<span class="sd">        Startup handlers are automatically registered as session-scoped dependencies,</span>
<span class="sd">        so their return values can be injected into route handlers and other dependencies.</span>
<span class="sd">        Handlers can be sync or async functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_startup_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="c1"># Also register as a session-scoped dependency so return value can be injected</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dependency</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">decorator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.on_shutdown">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.on_shutdown">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a shutdown handler to run when the application stops.</span>

<span class="sd">        Can be used as a decorator::</span>

<span class="sd">            @app.on_shutdown</span>
<span class="sd">            async def shutdown():</span>
<span class="sd">                print(&quot;Application shutting down...&quot;)</span>
<span class="sd">                # Close connections, cleanup resources, etc.</span>

<span class="sd">        Or called directly::</span>

<span class="sd">            app.on_shutdown(my_shutdown_function)</span>

<span class="sd">        Handlers can be sync or async functions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span>

        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">decorator</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.startup">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.startup">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run all registered startup handlers.</span>

<span class="sd">        This is called automatically by the ASGI adapter when the</span>
<span class="sd">        application starts. Handlers are run in registration order.</span>

<span class="sd">        The return values from startup handlers are cached in the session</span>
<span class="sd">        scope, making them available as dependencies throughout the application</span>
<span class="sd">        lifetime without being re-executed.</span>

<span class="sd">        Raises any exceptions from startup handlers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Guard against double execution</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startup_executed</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_startup_executed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_startup_handlers</span><span class="p">:</span>
            <span class="c1"># Execute the handler and get its return value</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="p">()</span>

            <span class="c1"># Cache the result in session scope so it can be injected as a dependency</span>
            <span class="c1"># without re-executing the handler on the first request</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependency_cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="s2">&quot;session&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.shutdown">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.shutdown">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run all registered shutdown handlers.</span>

<span class="sd">        This is called automatically by the ASGI adapter when the</span>
<span class="sd">        application stops. Handlers are run in registration order.</span>

<span class="sd">        Shutdown handlers support dependency injection, allowing them to</span>
<span class="sd">        inject session-scoped dependencies (like database connections from</span>
<span class="sd">        startup handlers) for proper cleanup.</span>

<span class="sd">        Logs exceptions from shutdown handlers but does not raise them.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_handlers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Resolve dependencies for the shutdown handler</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">param_type</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">param</span><span class="o">.</span><span class="n">annotation</span>
                        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
                        <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">)</span>
                    <span class="c1"># Pass None for request since shutdown handlers don&#39;t have request context</span>
                    <span class="n">resolved_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_dependency</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">param_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolved_value</span>

                <span class="c1"># Call the handler with resolved dependencies</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
                    <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in shutdown handler: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.startup_sync">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.startup_sync">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">startup_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronous wrapper for startup().</span>

<span class="sd">        This is called automatically by the AWS Lambda adapter during cold start</span>
<span class="sd">        to execute startup handlers in a synchronous context (module-level initialization).</span>

<span class="sd">        Uses anyio.run() to execute the async startup() method synchronously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">anyio</span>
        <span class="n">anyio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startup</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.shutdown_sync">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.shutdown_sync">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronous wrapper for shutdown().</span>

<span class="sd">        This can be called by AWS Lambda Extensions or other synchronous shutdown hooks</span>
<span class="sd">        to execute shutdown handlers in a synchronous context.</span>

<span class="sd">        Uses anyio.run() to execute the async shutdown() method synchronously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">anyio</span>
        <span class="n">anyio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.execute">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.execute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a request through the state machine.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create a new state machine for each request to avoid state pollution</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">restmachine.state_machine</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestStateMachine</span>
            <span class="n">state_machine</span> <span class="o">=</span> <span class="n">RequestStateMachine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">state_machine</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unhandled exception processing </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                <span class="mi">500</span><span class="p">,</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Internal server error&quot;</span><span class="p">}),</span>
                <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span>
            <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_is_pydantic_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the annotation is a Pydantic model.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PYDANTIC_AVAILABLE</span> <span class="ow">or</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s2">&quot;model_fields&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                <span class="n">annotation</span><span class="p">,</span> <span class="s2">&quot;model_validate&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_optional_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Type</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if type annotation is Optional and return the inner type.&quot;&quot;&quot;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="n">Union</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="c1"># This is Optional[T] which is Union[T, None]</span>
                <span class="n">inner_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inner_type</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">annotation</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pydantic_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract JSON schema from Pydantic model and convert to OpenAPI 3.0 compliant format.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pydantic_model</span><span class="p">(</span><span class="n">model_class</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pydantic_schema</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="n">model_json_schema</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_pydantic_schema_to_openapi</span><span class="p">(</span><span class="n">pydantic_schema</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_pydantic_schema_to_openapi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert Pydantic JSON schema to OpenAPI 3.0 compliant schema.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">converted</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;anyOf&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># Handle anyOf patterns for optional fields</span>
                    <span class="n">converted</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_anyof_to_nullable</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;exclusiveMinimum&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                    <span class="c1"># Convert exclusiveMinimum from number to boolean + minimum</span>
                    <span class="n">converted</span><span class="p">[</span><span class="s2">&quot;minimum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">converted</span><span class="p">[</span><span class="s2">&quot;exclusiveMinimum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;exclusiveMaximum&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                    <span class="c1"># Convert exclusiveMaximum from number to boolean + maximum</span>
                    <span class="n">converted</span><span class="p">[</span><span class="s2">&quot;maximum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">converted</span><span class="p">[</span><span class="s2">&quot;exclusiveMaximum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="c1"># Recursively convert nested schemas</span>
                    <span class="n">converted</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_pydantic_schema_to_openapi</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># Process lists (like in anyOf, oneOf, etc.)</span>
                    <span class="n">converted</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_pydantic_schema_to_openapi</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="n">item</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">converted</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">converted</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">schema</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_anyof_to_nullable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anyof_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert anyOf with null to nullable field for OpenAPI 3.0.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Check if this is the pattern: anyOf: [{&quot;type&quot;: &quot;someType&quot;}, {&quot;type&quot;: &quot;null&quot;}]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">anyof_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">type_schema</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">has_null</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">anyof_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;null&quot;</span><span class="p">:</span>
                        <span class="n">has_null</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">type_schema</span> <span class="o">=</span> <span class="n">item</span>

            <span class="k">if</span> <span class="n">has_null</span> <span class="ow">and</span> <span class="n">type_schema</span><span class="p">:</span>
                <span class="c1"># Convert to nullable field</span>
                <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_pydantic_schema_to_openapi</span><span class="p">(</span><span class="n">type_schema</span><span class="p">))</span>
                <span class="n">result</span><span class="p">[</span><span class="s2">&quot;nullable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># If it&#39;s not the nullable pattern, keep as anyOf but convert each schema</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;anyOf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_pydantic_schema_to_openapi</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">anyof_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_pydantic_field_to_openapi_param</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_info</span><span class="p">,</span> <span class="n">model_class</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a Pydantic field to OpenAPI parameter definition.&quot;&quot;&quot;</span>
        <span class="n">param</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
            <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>  <span class="c1"># Will be overridden for path params</span>
            <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Get field info from Pydantic model</span>
            <span class="n">field_annotation</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field_annotation</span><span class="p">:</span>
                <span class="c1"># Check if field is optional</span>
                <span class="n">is_optional</span><span class="p">,</span> <span class="n">inner_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_optional_type</span><span class="p">(</span>
                    <span class="n">field_annotation</span><span class="o">.</span><span class="n">annotation</span>
                <span class="p">)</span>
                <span class="n">param</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_optional</span> <span class="ow">and</span> <span class="n">field_annotation</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span>

                <span class="c1"># Basic type mapping</span>
                <span class="k">if</span> <span class="n">inner_type</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">inner_type</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">inner_type</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">}</span>
                <span class="k">elif</span> <span class="n">inner_type</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>

                <span class="c1"># Add description if available</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">field_annotation</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">field_annotation</span><span class="o">.</span><span class="n">description</span>
                <span class="p">):</span>
                    <span class="n">param</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_annotation</span><span class="o">.</span><span class="n">description</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">param</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_infer_schema_from_validation_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">collect_schema_func</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RouteHandler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Infer schema from validation dependencies that might use the given parameter (e.g. json_body).&quot;&quot;&quot;</span>
        <span class="c1"># Look for global validation dependencies that take the parameter as input</span>
        <span class="k">for</span> <span class="n">validation_name</span><span class="p">,</span> <span class="n">validation_wrapper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_dependencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">validation_wrapper</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="c1"># This validation function takes the parameter as input</span>
                <span class="n">return_annotation</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span>
                <span class="k">if</span> <span class="n">return_annotation</span> <span class="ow">and</span> <span class="n">return_annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pydantic_model</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">):</span>
                        <span class="c1"># Collect the schema and return a reference</span>
                        <span class="n">schema_name</span> <span class="o">=</span> <span class="n">collect_schema_func</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">schema_name</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$ref&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;#/components/schemas/</span><span class="si">{</span><span class="n">schema_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_primary_content_type_for_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">RouteHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the primary content type that this route expects for request bodies.&quot;&quot;&quot;</span>
        <span class="c1"># Check global accepts dependencies</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependencies</span><span class="p">:</span>
            <span class="c1"># Return the first global accepts dependency content type</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependencies</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default to application/json</span>
            <span class="k">return</span> <span class="s2">&quot;application/json&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_infer_basic_schema_from_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_annotation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Infer basic OpenAPI schema from Python type annotation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">type_annotation</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">type_annotation</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">type_annotation</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">type_annotation</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">}</span>
        <span class="k">elif</span> <span class="n">type_annotation</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}}</span>
        <span class="k">elif</span> <span class="n">type_annotation</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default fallback for unknown types</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>

<div class="viewcode-block" id="RestApplication.generate_openapi_json">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.generate_openapi_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_openapi_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;REST API&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;API generated by REST Framework&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate OpenAPI 3.0 JSON specification from registered routes.&quot;&quot;&quot;</span>

        <span class="c1"># Keep track of all schemas we&#39;ve seen to avoid duplicates</span>
        <span class="n">collected_schemas</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_collect_schema</span><span class="p">(</span><span class="n">model_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Collect a Pydantic model schema and return its reference name.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pydantic_model</span><span class="p">(</span><span class="n">model_class</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">schema_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="n">schema_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collected_schemas</span><span class="p">:</span>
                <span class="n">collected_schemas</span><span class="p">[</span><span class="n">schema_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pydantic_schema</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">schema_name</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_schema_ref</span><span class="p">(</span><span class="n">schema_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Get a $ref object for a schema.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$ref&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;#/components/schemas/</span><span class="si">{</span><span class="n">schema_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_extract_path_parameters</span><span class="p">(</span>
            <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">RouteHandler</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Extract path parameters from a route path.&quot;&quot;&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># First, check if there are validation dependencies that depend on path_params</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">path_params_from_validation</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Check if this parameter corresponds to a global validation dependency</span>
                <span class="n">validation_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">validation_wrapper</span><span class="p">:</span>
                    <span class="c1"># Check if this validation function depends on path_params</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">hasattr</span><span class="p">(</span><span class="n">validation_wrapper</span><span class="p">,</span> <span class="s2">&quot;depends_on_path_params&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">validation_wrapper</span><span class="o">.</span><span class="n">depends_on_path_params</span>
                    <span class="p">):</span>
                        <span class="c1"># Get the return type annotation of the validation function</span>
                        <span class="n">return_annotation</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span>
                            <span class="n">validation_wrapper</span><span class="o">.</span><span class="n">func</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">return_annotation</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">return_annotation</span>
                            <span class="ow">and</span> <span class="n">return_annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
                        <span class="p">):</span>
                            <span class="c1"># Extract Pydantic model fields</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pydantic_model</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">model_fields</span> <span class="o">=</span> <span class="n">return_annotation</span><span class="o">.</span><span class="n">model_fields</span>
                                    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="n">param_def</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_field_to_openapi_param</span><span class="p">(</span>
                                                <span class="n">field_name</span><span class="p">,</span>
                                                <span class="n">field_info</span><span class="p">,</span>
                                                <span class="n">return_annotation</span><span class="p">,</span>
                                            <span class="p">)</span>
                                        <span class="p">)</span>
                                        <span class="n">param_def</span><span class="p">[</span><span class="s2">&quot;in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="s2">&quot;path&quot;</span>  <span class="c1"># Set to path instead of the default</span>
                                        <span class="p">)</span>
                                        <span class="n">path_params_from_validation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_def</span><span class="p">)</span>
                                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                                    <span class="c1"># If we can&#39;t extract fields, skip this validation function</span>
                                    <span class="k">pass</span>

            <span class="c1"># If we found path parameters from validation dependencies, use those</span>
            <span class="k">if</span> <span class="n">path_params_from_validation</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path_params_from_validation</span>

            <span class="c1"># Otherwise, fall back to extracting from path pattern (assuming strings)</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{(\w+)\}&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">param_name</span><span class="p">,</span>
                        <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">params</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_extract_query_string_parameters</span><span class="p">(</span>
            <span class="n">route</span><span class="p">:</span> <span class="n">RouteHandler</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Extract query string parameters from validation dependencies.&quot;&quot;&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Look at the route handler&#39;s parameters to find validation dependencies</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Check if this parameter corresponds to a global validation dependency</span>
                <span class="n">validation_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">validation_wrapper</span><span class="p">:</span>
                    <span class="c1"># Check if this validation function depends on query_params</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">hasattr</span><span class="p">(</span><span class="n">validation_wrapper</span><span class="p">,</span> <span class="s2">&quot;depends_on_query_params&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">validation_wrapper</span><span class="o">.</span><span class="n">depends_on_query_params</span>
                    <span class="p">):</span>
                        <span class="c1"># Get the return type annotation of the validation function</span>
                        <span class="n">return_annotation</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span>
                            <span class="n">validation_wrapper</span><span class="o">.</span><span class="n">func</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">return_annotation</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">return_annotation</span>
                            <span class="ow">and</span> <span class="n">return_annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
                        <span class="p">):</span>
                            <span class="c1"># Extract Pydantic model fields</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pydantic_model</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">):</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">model_fields</span> <span class="o">=</span> <span class="n">return_annotation</span><span class="o">.</span><span class="n">model_fields</span>
                                    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="n">param_def</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_pydantic_field_to_openapi_param</span><span class="p">(</span>
                                                <span class="n">field_name</span><span class="p">,</span>
                                                <span class="n">field_info</span><span class="p">,</span>
                                                <span class="n">return_annotation</span><span class="p">,</span>
                                            <span class="p">)</span>
                                        <span class="p">)</span>
                                        <span class="n">param_def</span><span class="p">[</span><span class="s2">&quot;in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                            <span class="s2">&quot;query&quot;</span>  <span class="c1"># Set to query instead of the default</span>
                                        <span class="p">)</span>
                                        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_def</span><span class="p">)</span>
                                <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                                    <span class="c1"># If we can&#39;t extract fields, skip this validation function</span>
                                    <span class="k">pass</span>

            <span class="k">return</span> <span class="n">params</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_extract_request_body_schema</span><span class="p">(</span>
            <span class="n">route</span><span class="p">:</span> <span class="n">RouteHandler</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Extract request body schema from validation dependencies, built-in parsers, and custom @accepts parsers.&quot;&quot;&quot;</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="p">)</span>

            <span class="c1"># First, check validation dependencies that depend on body</span>
            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Check if this parameter corresponds to a global validation dependency</span>
                <span class="n">validation_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">validation_wrapper</span><span class="p">:</span>
                    <span class="c1"># Check if this validation function depends on body</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">hasattr</span><span class="p">(</span><span class="n">validation_wrapper</span><span class="p">,</span> <span class="s2">&quot;depends_on_body&quot;</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">validation_wrapper</span><span class="o">.</span><span class="n">depends_on_body</span>
                    <span class="p">):</span>
                        <span class="c1"># Get the return type annotation of the validation function</span>
                        <span class="n">return_annotation</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span>
                            <span class="n">validation_wrapper</span><span class="o">.</span><span class="n">func</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">return_annotation</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">return_annotation</span>
                            <span class="ow">and</span> <span class="n">return_annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>
                        <span class="p">):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pydantic_model</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">):</span>
                                <span class="c1"># Collect the schema and return a reference</span>
                                <span class="n">schema_name</span> <span class="o">=</span> <span class="n">_collect_schema</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">schema_name</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="n">_get_schema_ref</span><span class="p">(</span><span class="n">schema_name</span><span class="p">)</span>

            <span class="c1"># Check for built-in parsers (json_body, form_body, etc.) and custom @accepts parsers</span>
            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Check if this parameter uses built-in parsers</span>
                <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;json_body&#39;</span><span class="p">,</span> <span class="s1">&#39;form_body&#39;</span><span class="p">,</span> <span class="s1">&#39;text_body&#39;</span><span class="p">,</span> <span class="s1">&#39;multipart_body&#39;</span><span class="p">]:</span>
                    <span class="c1"># For built-in parsers, try to infer schema from validation dependencies that use them</span>
                    <span class="n">schema_from_validation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_schema_from_validation_dependencies</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">_collect_schema</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">schema_from_validation</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">schema_from_validation</span>

                    <span class="c1"># Default schemas for built-in parsers when no validation is found</span>
                    <span class="k">if</span> <span class="n">param_name</span> <span class="o">==</span> <span class="s1">&#39;json_body&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>
                    <span class="k">elif</span> <span class="n">param_name</span> <span class="o">==</span> <span class="s1">&#39;form_body&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Form data&quot;</span><span class="p">}</span>
                    <span class="k">elif</span> <span class="n">param_name</span> <span class="o">==</span> <span class="s1">&#39;text_body&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}</span>
                    <span class="k">elif</span> <span class="n">param_name</span> <span class="o">==</span> <span class="s1">&#39;multipart_body&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Multipart form data&quot;</span><span class="p">}</span>

                <span class="c1"># Check if this parameter might be resolved through custom @accepts parsers</span>
                <span class="c1"># Look for accepts dependencies that match this route</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_primary_content_type_for_route</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">content_type</span><span class="p">:</span>
                    <span class="c1"># Check global accepts dependencies</span>
                    <span class="k">if</span> <span class="n">content_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependencies</span><span class="p">:</span>
                        <span class="n">accepts_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accepts_dependencies</span><span class="p">[</span><span class="n">content_type</span><span class="p">]</span>
                        <span class="n">return_annotation</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">accepts_wrapper</span><span class="o">.</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">return_annotation</span>
                        <span class="k">if</span> <span class="n">return_annotation</span> <span class="ow">and</span> <span class="n">return_annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pydantic_model</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">):</span>
                                <span class="n">schema_name</span> <span class="o">=</span> <span class="n">_collect_schema</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">schema_name</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="n">_get_schema_ref</span><span class="p">(</span><span class="n">schema_name</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># For non-Pydantic return types, infer basic schema</span>
                                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_basic_schema_from_type</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_extract_response_schema</span><span class="p">(</span><span class="n">route</span><span class="p">:</span> <span class="n">RouteHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Extract response schema from handler return type annotation. Returns None if no schema should be included.&quot;&quot;&quot;</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">return_annotation</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span>

            <span class="c1"># Check if return type is explicitly None</span>
            <span class="k">if</span> <span class="n">return_annotation</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># No schema for 204 responses</span>

            <span class="c1"># Check if no annotation is provided</span>
            <span class="k">if</span> <span class="n">return_annotation</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># No schema for unannotated handlers</span>

            <span class="k">if</span> <span class="n">return_annotation</span> <span class="ow">and</span> <span class="n">return_annotation</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Handle Optional types</span>
                <span class="n">is_optional</span><span class="p">,</span> <span class="n">inner_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_optional_type</span><span class="p">(</span><span class="n">return_annotation</span><span class="p">)</span>
                <span class="n">actual_type</span> <span class="o">=</span> <span class="n">inner_type</span> <span class="k">if</span> <span class="n">is_optional</span> <span class="k">else</span> <span class="n">return_annotation</span>

                <span class="c1"># Handle List types</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">get_origin</span><span class="p">(</span><span class="n">actual_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="c1"># This is List[SomeType]</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">get_args</span><span class="p">(</span><span class="n">actual_type</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pydantic_model</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">schema_name</span> <span class="o">=</span> <span class="n">_collect_schema</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">schema_name</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">_get_schema_ref</span><span class="p">(</span><span class="n">schema_name</span><span class="p">),</span>
                            <span class="p">}</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_pydantic_model</span><span class="p">(</span><span class="n">actual_type</span><span class="p">):</span>
                    <span class="n">schema_name</span> <span class="o">=</span> <span class="n">_collect_schema</span><span class="p">(</span><span class="n">actual_type</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">schema_name</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">_get_schema_ref</span><span class="p">(</span><span class="n">schema_name</span><span class="p">)</span>

            <span class="c1"># Default fallback for other annotated types</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_route_uses_validation_dependencies</span><span class="p">(</span><span class="n">route</span><span class="p">:</span> <span class="n">RouteHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check if a route uses any validation dependencies that return Pydantic models.&quot;&quot;&quot;</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validation_dependencies</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_convert_path_to_openapi</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Convert {param} syntax to OpenAPI {param} syntax.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">path</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_get_operation_info</span><span class="p">(</span><span class="n">route</span><span class="p">:</span> <span class="n">RouteHandler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Extract operation information from a route handler.&quot;&quot;&quot;</span>
            <span class="c1"># Extract response schema from handler return type</span>
            <span class="n">response_schema</span> <span class="o">=</span> <span class="n">_extract_response_schema</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

            <span class="c1"># Check if this is a None return type (should use 204)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">return_annotation</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span>

            <span class="n">operation</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span>
                <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">return_annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Handler explicitly returns None -&gt; 204 No Content</span>
                <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">][</span><span class="s2">&quot;204&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;No Content&quot;</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">response_schema</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># No annotation or no schema -&gt; 200 without content schema</span>
                <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">][</span><span class="s2">&quot;200&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Successful response&quot;</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">response_schema</span><span class="p">:</span>
                <span class="c1"># Has schema -&gt; 200 with content</span>
                <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">][</span><span class="s2">&quot;200&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Successful response&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;application/json&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">response_schema</span><span class="p">}},</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Has schema -&gt; 200 with content</span>
                <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">][</span><span class="s2">&quot;200&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Successful response&quot;</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Check if this route uses validation dependencies and add 422 response</span>
            <span class="n">uses_validation</span> <span class="o">=</span> <span class="n">_route_uses_validation_dependencies</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">uses_validation</span><span class="p">:</span>
                <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">][</span><span class="s2">&quot;422&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Validation Error&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;application/json&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                                    <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">}</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>

            <span class="c1"># Add description from docstring if available</span>
            <span class="k">if</span> <span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
                <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># Add path parameters</span>
            <span class="n">path_params</span> <span class="o">=</span> <span class="n">_extract_path_parameters</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
            <span class="c1"># Add query string parameters</span>
            <span class="n">query_params</span> <span class="o">=</span> <span class="n">_extract_query_string_parameters</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

            <span class="c1"># Combine all parameters</span>
            <span class="n">all_params</span> <span class="o">=</span> <span class="n">path_params</span> <span class="o">+</span> <span class="n">query_params</span>
            <span class="k">if</span> <span class="n">all_params</span><span class="p">:</span>
                <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_params</span>

            <span class="c1"># Add request body for POST/PUT/PATCH methods</span>
            <span class="k">if</span> <span class="n">route</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;PATCH&quot;</span><span class="p">]:</span>
                <span class="c1"># Try to extract request body schema from validation dependencies</span>
                <span class="n">request_body_schema</span> <span class="o">=</span> <span class="n">_extract_request_body_schema</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">request_body_schema</span><span class="p">:</span>
                    <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;requestBody&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;application/json&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">request_body_schema</span><span class="p">}}</span>
                    <span class="p">}</span>

            <span class="k">return</span> <span class="n">operation</span>

        <span class="c1"># Build the OpenAPI specification</span>
        <span class="n">openapi_spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;openapi&quot;</span><span class="p">:</span> <span class="s2">&quot;3.0.0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">},</span>
            <span class="s2">&quot;paths&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

        <span class="c1"># Process all routes to collect schemas and build paths</span>
        <span class="c1"># Get routes from root router (including mounted routers)</span>
        <span class="n">all_routes</span> <span class="o">=</span> <span class="p">[</span><span class="n">route</span> <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">route</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_router</span><span class="o">.</span><span class="n">get_all_routes</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">all_routes</span><span class="p">:</span>
            <span class="n">openapi_path</span> <span class="o">=</span> <span class="n">_convert_path_to_openapi</span><span class="p">(</span><span class="n">route</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">openapi_path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">openapi_spec</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">]:</span>
                <span class="n">openapi_spec</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">][</span><span class="n">openapi_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">method_lower</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">openapi_spec</span><span class="p">[</span><span class="s2">&quot;paths&quot;</span><span class="p">][</span><span class="n">openapi_path</span><span class="p">][</span><span class="n">method_lower</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_operation_info</span><span class="p">(</span>
                <span class="n">route</span>
            <span class="p">)</span>

        <span class="c1"># Add components section if we have collected schemas</span>
        <span class="k">if</span> <span class="n">collected_schemas</span><span class="p">:</span>
            <span class="n">openapi_spec</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schemas&quot;</span><span class="p">:</span> <span class="n">collected_schemas</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">openapi_spec</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="RestApplication.save_openapi_json">
<a class="viewcode-back" href="../../api.html#restmachine.application.RestApplication.save_openapi_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_openapi_json</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;openapi.json&quot;</span><span class="p">,</span>
        <span class="n">docs_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;docs&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;REST API&quot;</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;API generated by REST Framework&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate and save OpenAPI JSON specification to a file in the docs directory.&quot;&quot;&quot;</span>

        <span class="c1"># Create docs directory if it doesn&#39;t exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">docs_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">docs_dir</span><span class="p">)</span>

        <span class="c1"># Generate OpenAPI JSON</span>
        <span class="n">openapi_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_openapi_json</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>

        <span class="c1"># Write to file</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docs_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">openapi_json</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">file_path</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, REST Framework Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>