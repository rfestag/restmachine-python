[tox]
envlist = py39,py310,py311,py312,py313,lint,type-check,docs
skip_missing_interpreters = True

[testenv]
# Skip automatic packaging since this is a monorepo workspace
skip_install = True
changedir = {toxinidir}
# Install packages in editable mode
deps =
    -e .
    -e ../restmachine-orm-dynamodb[test]
commands =
    # Test core ORM package
    pytest tests -m 'not performance' --cov=src --cov-report=xml --cov-report=term --cov-config=pyproject.toml -q
    # Test DynamoDB package
    pytest ../restmachine-orm-dynamodb/tests -v -q

[testenv:lint]
skip_install = True
deps =
    ruff
commands =
    ruff check --fix src
    ruff check --fix ../restmachine-orm-dynamodb/src
    ruff check --fix tests
    ruff check --fix ../restmachine-orm-dynamodb/tests

[testenv:format]
skip_install = True
deps =
    ruff
commands =
    ruff format src
    ruff format ../restmachine-orm-dynamodb/src
    ruff format tests
    ruff format ../restmachine-orm-dynamodb/tests

[testenv:type-check]
skip_install = True
deps =
    mypy
    types-setuptools
    pydantic>=2.0.0
    boto3>=1.26.0
    # Install packages so mypy can resolve imports
    -e .
    -e ../restmachine-orm-dynamodb
changedir = {toxinidir}
setenv =
    MYPYPATH = src:../restmachine-orm-dynamodb/src
commands =
    mypy src/restmachine_orm --check-untyped-defs
    mypy ../restmachine-orm-dynamodb/src/restmachine_orm_dynamodb --check-untyped-defs

[testenv:docs]
skip_install = True
deps =
    mkdocs-material>=9.0.0
    mkdocstrings[python]>=0.24.0
    mkdocs-mermaid2-plugin>=1.0.0
commands =
    mkdocs build --strict --verbose

[testenv:build]
skip_install = True
deps =
    build
    twine
changedir = {toxinidir}
commands =
    python -m build .
    python -m build ../restmachine-orm-dynamodb
    twine check dist/*
    twine check ../restmachine-orm-dynamodb/dist/*

[testenv:clean]
skip_install = True
deps =
commands =
    python -c "import shutil; shutil.rmtree('dist', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('build', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('.tox', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('../restmachine-orm-dynamodb/dist', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('../restmachine-orm-dynamodb/build', ignore_errors=True)"

[testenv:security]
skip_install = True
deps =
    bandit[sarif]
    pip-audit
commands =
    bandit -r src ../restmachine-orm-dynamodb/src -f txt
    bandit -r src ../restmachine-orm-dynamodb/src -f sarif -o bandit-report.sarif
    pip-audit --skip-editable --format=columns

[testenv:complexity]
skip_install = True
deps =
    radon>=6.0.0
changedir = {toxinidir}
commands =
    # Cyclomatic Complexity - fail if average complexity > B (10)
    radon cc src ../restmachine-orm-dynamodb/src --total-average --show-complexity --min B
    # Maintainability Index - fail if any file is below B (65)
    radon mi src ../restmachine-orm-dynamodb/src --min B --show
    # Raw metrics for informational purposes
    radon raw src ../restmachine-orm-dynamodb/src --summary
